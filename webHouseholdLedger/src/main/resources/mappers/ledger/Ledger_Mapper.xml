<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="ledger">
	
	<select id="ledger.selectLedgerList" parameterType="ledgerSelectDTO" resultType="hashmap">
    	<![CDATA[
		SELECT LEDGER_IDX, DATE, INCOME_AND_EXPENSES, CATEGORY, DESCRIPTION, AMOUNT, ASSET, FORMER_ASSET, LATTER_ASSET
		FROM LEDGER
		WHERE USER_IDX = #{user_idx}
		AND DATE = #{date}
		ORDER BY DATE DESC;
        ]]>
    </select>
    
    <select id="ledger.selectLedgerGroup" parameterType="ledgerSelectDTO" resultType="hashmap">
    	<![CDATA[
    	SELECT DATE, COUNT(*) 'CNT', SUM(CASE WHEN INCOME_AND_EXPENSES='수입' THEN AMOUNT ELSE 0 END) 'INCOME', SUM(CASE WHEN INCOME_AND_EXPENSES='지출' THEN AMOUNT ELSE 0 END) 'EXPENSES'
    	FROM LEDGER
    	WHERE USER_IDX = #{user_idx}
    	GROUP BY DATE
    	HAVING DATE BETWEEN #{start_date} AND #{end_date}
    	ORDER BY DATE DESC
    	]]>
    </select>
    
    <select id="ledger.selectLedgerSummary" parameterType="ledgerSelectDTO" resultType="hashmap">
    	<![CDATA[
    	SELECT 
    		SUM(
    			CASE 
    				WHEN INCOME_AND_EXPENSES='수입' 
    				THEN AMOUNT 
    				ELSE 0 END
    			) 'INCOME', 
    		SUM(
    			CASE 
    				WHEN INCOME_AND_EXPENSES='지출' 
    				THEN AMOUNT 
    				ELSE 0 END
    			) 'EXPENSES', 
    		SUM(
    			CASE 
    				WHEN INCOME_AND_EXPENSES='수입' 
    				THEN AMOUNT 
    				WHEN INCOME_AND_EXPENSES='지출' 
    				THEN -AMOUNT
    				ELSE 0 END
    			) 'TOTAL'
    	FROM LEDGER
    	WHERE USER_IDX = #{user_idx}
    	AND DATE BETWEEN #{start_date} AND #{end_date}
    	]]>
    </select>
    
    <insert id="ledger.insertIncomeAndExpensesLedger" parameterType="ledgerInsertDTO">
    	<![CDATA[
    	INSERT INTO LEDGER
    		(USER_IDX, DATE, INCOME_AND_EXPENSES, CATEGORY, DESCRIPTION, AMOUNT, ASSET)
    	VALUES
    		(#{user_idx}, #{date}, #{income_and_expenses}, #{category}, #{description}, #{amount}, #{asset})
    	]]>
    </insert>
    
    <insert id="ledger.insertTransferLedger" parameterType="ledgerInsertDTO">
    	<![CDATA[
    	INSERT INTO LEDGER
    		(USER_IDX, DATE, INCOME_AND_EXPENSES, DESCRIPTION, AMOUNT, FORMER_ASSET, LATTER_ASSET)
    	VALUES
    		(#{user_idx}, #{date}, #{income_and_expenses}, #{description}, #{amount}, #{former_asset}, #{latter_asset})
    	]]>
    </insert>
    
    <update id="ledger.updateIncomeAndExpensesLedger" parameterType="ledgerInsertDTO">
    	<![CDATA[
    	UPDATE LEDGER
    	SET DATE = #{date},
    		INCOME_AND_EXPENSES = #{income_and_expenses},
    		CATEGORY = #{category},
    		DESCRIPTION = #{description},
    		AMOUNT = #{amount},
    		ASSET = #{asset}
    	WHERE LEDGER_IDX = #{ledger_idx}
    	AND USER_IDX = #{user_idx}
    	]]>
    </update>
    
    <update id="ledger.updateTransferLedger" parameterType="ledgerInsertDTO">
    	<![CDATA[
    	UPDATE LEDGER
    	SET DATE = #{date},
    		INCOME_AND_EXPENSES = #{income_and_expenses},
    		DESCRIPTION = #{description},
    		AMOUNT = #{amount},
    		FORMER_ASSET = #{former_asset},
    		LATTER_ASSET = #{latter_asset}
    	WHERE LEDGER_IDX = #{ledger_idx}
    	AND USER_IDX = #{user_idx}
    	]]>
    </update>
    
    <delete id="ledger.deleteLedger" parameterType="ledgerInsertDTO">
    	<![CDATA[
    	DELETE FROM LEDGER
    	WHERE LEDGER_IDX = #{ledger_idx}
    	AND USER_IDX = #{user_idx}
    	]]>
    </delete>

</mapper>